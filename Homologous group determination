for i in "AAA BBB CCC ..."; do
    echo "diamond blastp -q DDD.pep.fa -d ${i}.pep.fa -o DDD${i}_results.txt -e 1 -f 6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore stitle -k 1 -p 80" >> diamond.bash
done

python diamond.merge.py > diamond.geneID.xls
python3 sequence_haplotypes.py ../diamond.out/diamond.geneID.xls all_Samples.pep_merge.fasta homology.haplotype.table.xls



diamond.merge.py:
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import glob
from collections import defaultdict

def parse_diamond_results(evalue_threshold=1e-2):
    """
    Parse DIAMOND alignment result files and extract qualified homologous genes
    
    Parameters:
        evalue_threshold: E-value threshold, default 1e-2
    
    Returns:
        Gene matching dictionary {reference gene ID: {material name: matched gene ID}}
    """
    # Store results: {reference gene: {material: best matching gene}}
    gene_matches = defaultdict(dict)
    
    # Find all *_results.txt files
    result_files = glob.glob("*_results.txt")
    
    if not result_files:
        print("Error: No *_results.txt files found", file=sys.stderr)
        return gene_matches
    
    for result_file in sorted(result_files):
        # Extract material name from filename (e.g., CG60_CG118_results.txt -> CG60_CG118)
        material_name = os.path.basename(result_file).replace("_results.txt", "")
        
        try:
            with open(result_file, 'r') as f:
                for line in f:
                    if line.strip():
                        fields = line.strip().split('\t')
                        
                        # Parse fields
                        query_id = fields[0]      # Query gene ID (reference genome)
                        subject_id = fields[1]    # Subject gene ID (other materials)
                        evalue = float(fields[10]) # E-value
                        
                        # Check if E-value meets the criteria (note: requires evalue < 1e-2)
                        if evalue < evalue_threshold:
                            # Since diamond used -k 1 parameter, each query only has one best match
                            # But for safety, still check if a match for this material already exists
                            if material_name not in gene_matches[query_id]:
                                gene_matches[query_id][material_name] = subject_id
        
        except FileNotFoundError:
            print(f"Warning: File {result_file} not found", file=sys.stderr)
            continue
        except Exception as e:
            print(f"Warning: Error processing file {result_file}: {str(e)}", file=sys.stderr)
            continue
    
    return gene_matches


def output_results(gene_matches):
    """
    Output result table
    
    Parameters:
        gene_matches: Gene matching dictionary
    """
    # Print header
    print("Reference_Gene_ID\tHomologous_Genes")
    
    # Get all reference genes and sort
    ref_genes = sorted(gene_matches.keys())
    
    for ref_gene in ref_genes:
        materials = gene_matches[ref_gene]
        
        # Skip if no qualified homologous genes
        if not materials:
            continue
        
        # Sort by material name and join gene IDs with semicolons
        sorted_materials = sorted(materials.keys())
        homolog_genes = ";".join([materials[mat] for mat in sorted_materials])
        
        # Output results
        print(f"{ref_gene}\t{homolog_genes}")


if __name__ == "__main__":
    import sys
    
    # Parse DIAMOND results
    gene_matches = parse_diamond_results(evalue_threshold=1e-2)
    
    # Output results
    output_results(gene_matches)



sequence_haplotypes.py:

#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Protein Sequence Haplotype Analysis Script
Classify homologous genes into haplotypes based on sequence length and content
"""

import sys
from collections import defaultdict

def parse_fasta(fasta_file):
    """Parse FASTA file and return sequence dictionary"""
    sequences = {}
    current_id = None
    current_seq = []
    
    with open(fasta_file, 'r') as f:
        for line in f:
            line = line.strip()
            if line.startswith('>'):
                if current_id:
                    sequences[current_id] = ''.join(current_seq)
                current_id = line[1:]  # Remove '>'
                current_seq = []
            else:
                current_seq.append(line)
        
        # Add the last sequence
        if current_id:
            sequences[current_id] = ''.join(current_seq)
    
    return sequences

def extract_material_name(gene_id):
    """Extract material name from gene ID"""
    # Format 1: Csa.CG1.1G000002.mRNA1
    # Format 2: Csa37_1G000280.1
    
    if gene_id.startswith('Csa.'):
        # First format: Csa.CG1.1G000002.mRNA1
        parts = gene_id.split('.')
        if len(parts) >= 3:
            material = parts[1]  # Extract CG1, CG10, CU2, etc.
            return material
    elif gene_id.startswith('Csa') and '_' in gene_id:
        # Second format: Csa37_1G000280.1, Csa9110gt_1G000190.1, etc.
        parts = gene_id.split('_')
        if len(parts) >= 2:
            material = parts[0]  # Extract Csa37, Csa9110gt, etc.
            return material
    
    return None

def classify_haplotypes(ref_gene_id, gene_ids, sequences, debug=False):
    """
    Classify genes into haplotypes
    Returns: {material: haplotype_number}
    Note: Includes reference genome and all homologous genes
    """
    # Collect all sequence information, including reference genome
    seq_info = []
    
    # First process the reference genome
    if ref_gene_id in sequences:
        seq = sequences[ref_gene_id]
        seq_info.append({
            'gene_id': ref_gene_id,
            'material': 'CsaV4',
            'sequence': seq,
            'length': len(seq)
        })
    
    # Then process homologous genes
    for gene_id in gene_ids:
        # Skip reference genome (already processed)
        if gene_id.startswith('CsaV4'):
            continue
        if gene_id in sequences:
            material = extract_material_name(gene_id)
            if material:
                seq = sequences[gene_id]
                seq_info.append({
                    'gene_id': gene_id,
                    'material': material,
                    'sequence': seq,
                    'length': len(seq)
                })
            elif debug:
                print(f"    Warning: Cannot extract material name: {gene_id}")
    
    if debug and len(seq_info) > 0:
        print(f"    Successfully extracted {len(seq_info)} sequence information (including reference genome)")
        print(f"    First 3 materials: {[s['material'] for s in seq_info[:3]]}")
    
    # Sort by length
    seq_info.sort(key=lambda x: x['length'])
    
    # Haplotype classification
    haplotypes = {}  # {material: haplotype_number}
    haplotype_groups = []  # [{length: X, sequences: [seq1, seq2...]}]
    current_haplotype = 1
    
    for info in seq_info:
        material = info['material']
        seq = info['sequence']
        seq_len = info['length']
        
        # Check if a haplotype with the same length and sequence already exists
        found = False
        for i, group in enumerate(haplotype_groups):
            if group['length'] == seq_len:
                # Same length, check if sequence is identical
                if seq in group['sequences']:
                    # Found the same haplotype
                    haplotypes[material] = group['haplotype']
                    found = True
                    break
        
        if not found:
            # No matching haplotype found, create a new one
            haplotypes[material] = current_haplotype
            haplotype_groups.append({
                'length': seq_len,
                'sequences': [seq],
                'haplotype': current_haplotype
            })
            current_haplotype += 1
    
    if debug:
        print(f"    Assigned haplotypes: {len(haplotypes)}")
        print(f"    Haplotype number range: 1-{current_haplotype-1}")
        if 'CsaV4' in haplotypes:
            print(f"    CsaV4 haplotype: {haplotypes['CsaV4']}")
    
    return haplotypes

def main(homology_file, fasta_file, output_file):
    """Main function"""
    # Read protein sequences
    print("Reading protein sequence file...")
    sequences = parse_fasta(fasta_file)
    print(f"Total sequences read: {len(sequences)}")
    
    # Get all material names (for header), including reference genome CsaV4
    all_materials = set()
    has_csav4 = False
    for gene_id in sequences.keys():
        if gene_id.startswith('CsaV4'):
            has_csav4 = True
            continue  # CsaV4 will be processed separately, not through extract_material_name
        material = extract_material_name(gene_id)
        if material:
            all_materials.add(material)
    
    # Sort material names, put CsaV4 at the front
    materials_list = ['CsaV4'] + sorted(all_materials) if has_csav4 else sorted(all_materials)
    print(f"Total materials found: {len(materials_list)} (including reference genome)")
    
    # Read homologous gene file and analyze
    print("Analyzing haplotypes...")
    results = []
    total_genes = 0
    matched_genes = 0
    
    with open(homology_file, 'r') as f:
        header = f.readline()  # Skip header
        
        for line_num, line in enumerate(f, start=2):
            line = line.strip()
            if not line:
                continue
            
            parts = line.split('\t')
            if len(parts) < 2:
                print(f"Warning: Line {line_num} data incomplete, skipping")
                continue
            
            ref_gene = parts[0]
            total_genes += 1
            
            # Process potentially truncated homologous gene list
            homologs_str = parts[1].strip()
            if not homologs_str:
                print(f"Warning: {ref_gene} has no homologous gene information")
                homologs = []
            else:
                homologs = [h.strip() for h in homologs_str.split(';') if h.strip()]
            
            # Debug information (only display first 3 genes)
            if total_genes <= 3:
                print(f"\nProcessing {ref_gene}:")
                print(f"  Number of homologous genes: {len(homologs)}")
                if len(homologs) > 0:
                    print(f"  First 3 homologous genes: {homologs[:3]}")
                    # Check if these genes are in the sequence file
                    found = sum(1 for h in homologs[:3] if h in sequences)
                    print(f"  Found in sequence file: {found}/{min(3, len(homologs))}")
            
            # Classify haplotypes (enable debug for first 3 genes), pass in reference gene ID
            haplotypes = classify_haplotypes(ref_gene, homologs, sequences, debug=(total_genes <= 3))
            
            if haplotypes:
                matched_genes += 1
            
            # Build result row
            result_row = [ref_gene]
            for material in materials_list:
                if material in haplotypes:
                    result_row.append(str(haplotypes[material]))
                else:
                    result_row.append('NA')  # This material has no corresponding homologous gene
            
            results.append(result_row)
    
    print(f"\nStatistics:")
    print(f"  Total reference genes: {total_genes}")
    print(f"  With matched homologous genes: {matched_genes}")
    print(f"  Match rate: {matched_genes/total_genes*100:.1f}%")
    
    # Write output file
    print(f"Writing output file: {output_file}")
    with open(output_file, 'w') as f:
        # Write header
        header = ['Reference_Gene_ID'] + materials_list
        f.write('\t'.join(header) + '\n')
        
        # Write data
        for row in results:
            f.write('\t'.join(row) + '\n')
    
    print(f"Complete! Analyzed {len(results)} reference genes in total")

if __name__ == '__main__':
    if len(sys.argv) != 4:
        print("Usage: python script.py <File_A> <File_B> <Output_File>")
        print("Example: python script.py homology.txt proteins.fasta output.txt")
        sys.exit(1)
    
    homology_file = sys.argv[1]
    fasta_file = sys.argv[2]
    output_file = sys.argv[3]
    
    main(homology_file, fasta_file, output_file)
